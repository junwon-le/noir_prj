<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.noir.mypageReserve">
<!-- 임시  -->
	<!-- <select id="selectTotalCnt" parameterType="reserveSearchDTO" resultType="int">
		
		select count(*)
			
			    FROM member m
			    JOIN reserve r ON m.member_num = r.member_num
			    JOIN room_res rr ON r.reserve_num = rr.reserve_num
			    JOIN room_info ri ON rr.room_type_num = ri.room_type_num
			    WHERE m.member_id = #{memberId}
			      AND r.reserve_type = 'room'
			      <if test="startDate != null">
			          AND rr.room_res_start_date &gt;= #{startDate}
			      </if>
			      <if test="endDate != null">
			          AND rr.room_res_end_date &lt;= #{endDate}
			      </if>
	
	
	</select>
 -->
		
<select id="selectTotalCnt" parameterType="reserveSearchDTO" resultType="int">
			    SELECT 
			        COUNT(*)
			    FROM member m
			    JOIN reserve r ON m.member_num = r.member_num
			    JOIN room_res rr ON r.reserve_num = rr.reserve_num
			    /* room_info 테이블은 개수 세는 데 필요 없으므로 성능을 위해 제외 가능 */
			    <where>
			        m.member_id = #{memberId}
			        AND r.reserve_type = 'room'
			        
			        <choose>
			            <when test="startDate != null and startDate != ''">
			                AND rr.room_res_start_date &gt;= #{startDate}
			            </when>
			            <otherwise>
			                AND rr.room_res_start_date &gt;= TRUNC(SYSDATE)
			            </otherwise>
			        </choose>
			
			        <if test="endDate != null and endDate != ''">
			            AND rr.room_res_end_date &lt;= #{endDate}
			        </if>
			    </where>
</select>
	
	
<!-- 이게 실제로 페이지내이션에 쓸것
<select id="hotelRevList" parameterType="reserveSearchDTO" resultType="hotelRevSearchDomain">
    SELECT 
        reserveNum, reserveDate, roomType, checkIn, checkOut, reservePerson, reserveFlag
    FROM (
        SELECT 
            ROW_NUMBER() OVER (ORDER BY r.reserve_num DESC) AS rnum,
            r.reserve_num AS reserveNum,      
            TRUNC(r.reserve_time) AS reserveDate, 
            ri.room_type AS roomType,         
           TRUNC(rr.room_res_start_date) AS checkIn,
            TRUNC(rr.room_res_end_date) AS checkOut,
            (r.reserve_adult_count + r.reserve_kid_count) AS reservePerson, 
            r.reserve_status AS reserveFlag   
        FROM member m
        JOIN reserve r ON m.member_num = r.member_num
        JOIN room_res rr ON r.reserve_num = rr.reserve_num
        JOIN room_info ri ON rr.room_type_num = ri.room_type_num
        <where>
            m.member_id = #{memberId}
            AND r.reserve_type = 'room'
            
            <choose>
                <when test="startDate != null">
                    AND rr.room_res_start_date &gt;= #{startDate}
                </when>
                <otherwise>
                    AND rr.room_res_start_date &gt;= TRUNC(SYSDATE)
                </otherwise>
            </choose>

            <if test="endDate != null">
                AND rr.room_res_end_date &lt;= #{endDate}
            </if>
        </where>
          ) 
    WHERE rnum BETWEEN #{startNum} AND #{endNum}
</select> -->



<!-- 이게 중욧 -->
<!-- 	<select id="hotelRevList" parameterType="reserveSearchDTO" resultType="hotelRevSearchDomain">
    SELECT 
        reserveNum, reserveDate, roomType, checkIn, checkOut, reservePerson, reserveFlag
    FROM (
        SELECT 
            ROW_NUMBER() OVER (ORDER BY r.reserve_num DESC) AS rnum,
            r.reserve_num AS reserveNum,      
            TRUNC(r.reserve_time) AS reserveDate, 
            ri.room_type AS roomType,         
            TRUNC(rr.room_res_start_date) AS checkIn,
            TRUNC(rr.room_res_end_date) AS checkOut,
            (r.reserve_adult_count + r.reserve_kid_count) AS reservePerson, 
            r.reserve_status AS reserveFlag   
        FROM member m
        JOIN reserve r ON m.member_num = r.member_num
        JOIN room_res rr ON r.reserve_num = rr.reserve_num
        JOIN room_info ri ON rr.room_type_num = ri.room_type_num
        WHERE m.member_id = #{memberId}
          AND r.reserve_type = 'room'
          ) 
    WHERE rnum BETWEEN #{startNum} AND #{endNum}
</select> -->



<!-- <select id="hotelRevList" parameterType="reserveSearchDTO" resultType="hotelRevSearchDomain">
    SELECT
        r.reserve_num AS reserveNum,      
        TRUNC(r.reserve_time) AS reserveDate, 
        ri.room_type AS roomType,         
        TRUNC(rr.room_res_start_date) AS checkIn,
        TRUNC(rr.room_res_end_date) AS checkOut,
        (r.reserve_adult_count + r.reserve_kid_count) AS reservePerson, 
        r.reserve_status AS reserveFlag   
        FROM member m
			    JOIN reserve r ON m.member_num = r.member_num
			    JOIN room_res rr ON r.reserve_num = rr.reserve_num
			    JOIN room_info ri ON rr.room_type_num = ri.room_type_num
			    WHERE m.member_id = #{memberId}
			      AND r.reserve_type = 'room'
			      <if test="startDate != null">
			          AND rr.room_res_start_date &gt;= #{startDate}
			      </if>
			      <if test="endDate != null">
			          AND rr.room_res_end_date &lt;= #{endDate}
			      </if>
			    ORDER BY r.reserve_num DESC
</select> -->



<!-- 			        m.member_id AS memberId, -->

  	<select id="hotelRevList" parameterType="reserveSearchDTO" resultType="hotelRevSearchDomain">
		select
					r.reserve_num AS reserveNum,
			        TRUNC(r.reserve_time) AS reserveDate,
			        ri.room_type AS roomType,
			        TRUNC(rr.room_res_start_date) AS checkIn,
			        TRUNC(rr.room_res_end_date) AS checkOut,
			        (r.reserve_adult_count + r.reserve_kid_count) AS reservePerson,
			        r.reserve_status AS reserveFlag
			    FROM member m
			    JOIN reserve r ON m.member_num = r.member_num
			    JOIN room_res rr ON r.reserve_num = rr.reserve_num
			    JOIN room_info ri ON rr.room_type_num = ri.room_type_num
			    WHERE m.member_id = #{memberId}
			      AND r.reserve_type = 'room'
			      <if test="startDate != null">
			          AND rr.room_res_start_date &gt;= #{startDate}
			      </if>
			      <if test="endDate != null">
			          AND rr.room_res_end_date &lt;= #{endDate}
			      </if>
			    ORDER BY r.reserve_num DESC
 	
 	</select>
 
	
	 
	

	
</mapper>




