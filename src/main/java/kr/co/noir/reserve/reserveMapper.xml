<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="kr.co.sist.reserve">
  	<select id="selectRoom" parameterType="roomSearchDTO" resultType="roomSearchDomain">
  	<![CDATA[
  SELECT 
    ri.room_type_num,
    ri.room_type,
    ri.room_detail,
    ri.room_img1,
    ri.room_max_person,
    -- 1. 시작일(체크인)의 가격
    MIN(CASE WHEN rp.room_date = TO_DATE(#{startDate}, 'yyyy-MM-dd') THEN rp.room_price END) AS start_date_price,
    -- 2. 전체 숙박 기간의 총 요금 합계
    SUM(rp.room_price) AS total_sum_price,
    -- 3. 예약된 방 개수
    NVL(ra.cnt, 0) AS reserved_count,
    -- 4. 남은 방 개수
    (ri.room_count - NVL(ra.cnt, 0)) AS available_count
FROM 
    room_info ri
JOIN 
    room_price rp ON ri.room_type_num = rp.room_type_num
LEFT JOIN (
    -- 해당 기간 내에 이미 예약된 방의 개수를 미리 계산
    SELECT 
        rr.room_type_num, 
        COUNT(*) AS cnt
    FROM 
        room_res rr
    JOIN 
        reserve r ON rr.reserve_num = r.reserve_num
    WHERE 
        r.reserve_status = 'N' -- 정상 예약건만
        AND r.reserve_start_date < TO_DATE(#{endDate}, 'yyyy-MM-dd')
        AND r.reserve_end_date > TO_DATE(#{startDate}, 'yyyy-MM-dd')
    GROUP BY 
        rr.room_type_num
) ra ON ri.room_type_num = ra.room_type_num
WHERE 
    -- 가격 테이블에서 사용자가 선택한 기간만큼만 데이터를 가져옴
    rp.room_date >= TO_DATE(#{startDate}, 'yyyy-MM-dd')
    AND rp.room_date < TO_DATE(#{endDate}, 'yyyy-MM-dd')
    GROUP BY 
    ri.room_type_num, 
    ri.room_type, 
    ri.room_detail, 
    ri.room_img1, 
    ri.room_max_person,
    ri.room_count,
    ra.cnt
HAVING 
    -- 방이 남아있는 경우만 노출
    (ri.room_count - NVL(ra.cnt, 0)) > 0
ORDER BY 
    start_date_price ASC
  	]]>
  	</select>
  	
  	<select id="selectMember" parameterType="String" resultType="memberDomain">
  		select member_num, member_id, member_last_name, member_pass, member_first_name, member_email, member_tel, member_birth, member_del_flag, 
  		member_inputdate, member_ip, member_provider, member_provider_id, num 
  		from member where member_id=#{member_id}
  	</select>
  </mapper>